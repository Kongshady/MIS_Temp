<?php
require_once '../db_connection.php';
$page_title = 'Patient Management';
include '../includes/header.php';

// Handle form submissions
$message = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['action'])) {
        if ($_POST['action'] == 'add') {
            $patient_type = $_POST['patient_type'];
            $walk_in_id = !empty($_POST['walk_in_id']) ? $_POST['walk_in_id'] : NULL;
            $employee_id = !empty($_POST['employee_id']) ? $_POST['employee_id'] : NULL;
            $student_id = !empty($_POST['student_id']) ? $_POST['student_id'] : NULL;
            $firstname = $_POST['firstname'];
            $middlename = $_POST['middlename'];
            $lastname = $_POST['lastname'];
            $birthdate = $_POST['birthdate'];
            $gender = $_POST['gender'];
            $contact_number = $_POST['contact_number'];
            $address = $_POST['address'];
            $physician_id = !empty($_POST['physician_id']) ? $_POST['physician_id'] : NULL;
            $status_code = $_POST['status_code'];
            
            $stmt = $conn->prepare("INSERT INTO patient (patient_type, walk_in_id, employee_id, student_id, firstname, middlename, lastname, birthdate, gender, contact_number, address, physician_id, status_code, datetime_added) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())");
            $stmt->bind_param("siissssssssii", $patient_type, $walk_in_id, $employee_id, $student_id, $firstname, $middlename, $lastname, $birthdate, $gender, $contact_number, $address, $physician_id, $status_code);
            
            if ($stmt->execute()) {
                $message = '<div class="alert alert-success">Patient added successfully!</div>';
            } else {
                $message = '<div class="alert alert-danger">Error: ' . $stmt->error . '</div>';
            }
        } elseif ($_POST['action'] == 'delete') {
            $patient_id = $_POST['patient_id'];
            $stmt = $conn->prepare("DELETE FROM patient WHERE patient_id=?");
            $stmt->bind_param("i", $patient_id);
            
            if ($stmt->execute()) {
                $message = '<div class="alert alert-success">Patient deleted successfully!</div>';
            } else {
                $message = '<div class="alert alert-danger">Error: ' . $stmt->error . '</div>';
            }
        }
    }
}

// Get all patients
$patients = $conn->query("SELECT p.*, ph.physician_name, s.label as status_label 
                         FROM patient p 
                         LEFT JOIN physician ph ON p.physician_id = ph.physician_id
                         LEFT JOIN status_code s ON p.status_code = s.status_code 
                         ORDER BY p.datetime_added DESC");

// Search functionality
$search_results = null;
if (isset($_GET['search']) && !empty($_GET['search'])) {
    $search = '%' . $_GET['search'] . '%';
    
    // Search in walk_in, employee, and student tables
    $search_query = "
        (SELECT 'walk-in' as type, walk_in_id as id, firstname, middlename, lastname, birthdate, gender, '' as additional_info
         FROM walk_in 
         WHERE firstname LIKE ? OR lastname LIKE ?)
        UNION
        (SELECT 'employee' as type, employee_id as id, firstname, middlename, lastname, NULL as birthdate, '' as gender, position as additional_info
         FROM employee 
         WHERE firstname LIKE ? OR lastname LIKE ?)
        UNION
        (SELECT 'student' as type, student_id as id, firstname, middlename, lastname, NULL as birthdate, '' as gender, course as additional_info
         FROM student 
         WHERE firstname LIKE ? OR lastname LIKE ? OR student_id LIKE ?)
    ";
    
    $stmt = $conn->prepare($search_query);
    $stmt->bind_param("sssssss", $search, $search, $search, $search, $search, $search, $search);
    $stmt->execute();
    $search_results = $stmt->get_result();
}
?>

<div class="container">
    <?php echo $message; ?>
    
    <div class="card">
        <div class="card-header">
            <h2>ðŸ‘¥ Patient Management</h2>
        </div>
        
        
        
        <!-- Add New Patient Form -->
        <form method="POST" id="addPatientForm" style="margin-bottom: 2rem;">
            <input type="hidden" name="action" value="add">
            <h3>Add New Patient</h3>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <div class="form-group">
                    <label>Patient Type *</label>
                    <select name="patient_type" id="patient_type" class="form-control" required onchange="togglePatientFields()">
                        <option value="walk-in">Walk-in</option>
                        <option value="employee">Employee</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                
                <div class="form-group" id="walk_in_field" style="display: none;">
                    <label>Walk-in ID</label>
                    <input type="number" name="walk_in_id" id="walk_in_id" class="form-control">
                </div>
                
                <div class="form-group" id="employee_field" style="display: none;">
                    <label>Employee ID</label>
                    <input type="number" name="employee_id" id="employee_id" class="form-control">
                </div>
                
                <div class="form-group" id="student_field" style="display: none;">
                    <label>Student ID</label>
                    <input type="text" name="student_id" id="student_id" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" name="firstname" id="firstname" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Middle Name</label>
                    <input type="text" name="middlename" id="middlename" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" name="lastname" id="lastname" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Birthdate *</label>
                    <input type="date" name="birthdate" id="birthdate" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Gender *</label>
                    <select name="gender" id="gender" class="form-control" required>
                        <option value="">Select Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Contact Number</label>
                    <input type="text" name="contact_number" id="contact_number" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" name="address" id="address" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Physician</label>
                    <select name="physician_id" class="form-control">
                        <option value="">Assign Physician</option>
                        <?php 
                        $physicians = $conn->query("SELECT * FROM physician WHERE status_code = 1 ORDER BY physician_name");
                        while($physician = $physicians->fetch_assoc()): 
                        ?>
                            <option value="<?php echo $physician['physician_id']; ?>"><?php echo htmlspecialchars($physician['physician_name']); ?></option>
                        <?php endwhile; ?>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Status *</label>
                    <select name="status_code" class="form-control" required>
                        <option value="">Select Status</option>
                        <?php 
                        $status_codes = $conn->query("SELECT * FROM status_code");
                        while($status = $status_codes->fetch_assoc()): 
                        ?>
                            <option value="<?php echo $status['status_code']; ?>"><?php echo htmlspecialchars($status['label']); ?></option>
                        <?php endwhile; ?>
                    </select>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">Add Patient</button>
        </form>
        
        <!-- Search Section -->
        <div style="margin-bottom: 2rem;">
            <h3>Search Student/Employee</h3>
            <form method="GET" style="display: flex; gap: 1rem; align-items: end;">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>Search by Name or Student ID</label>
                    <input type="text" name="search" class="form-control" placeholder="Enter name or student ID" value="<?php echo isset($_GET['search']) ? htmlspecialchars($_GET['search']) : ''; ?>">
                </div>
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
            
            <?php if ($search_results): ?>
                <div style="margin-top: 1rem;">
                    <h4>Search Results:</h4>
                    <?php if ($search_results->num_rows > 0): ?>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Additional Info</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php while($result = $search_results->fetch_assoc()): ?>
                                    <tr>
                                        <td><?php echo strtoupper($result['type']); ?></td>
                                        <td><?php echo htmlspecialchars($result['id']); ?></td>
                                        <td><?php echo htmlspecialchars($result['firstname'] . ' ' . $result['middlename'] . ' ' . $result['lastname']); ?></td>
                                        <td><?php echo htmlspecialchars($result['additional_info']); ?></td>
                                        <td>
                                            <button class="btn btn-success btn-sm" onclick="addAsPatient(<?php echo htmlspecialchars(json_encode($result)); ?>)">Add as Patient</button>
                                        </td>
                                    </tr>
                                <?php endwhile; ?>
                            </tbody>
                        </table>
                    <?php else: ?>
                        <p>No results found.</p>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        </div>

        <!-- All Patients List -->
        <h3>All Patients</h3>
        <?php if ($patients->num_rows > 0): ?>
            <table class="table">
                <thead>
                    <tr>
                        <th>Patient ID</th>
                        <th>Type</th>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Gender</th>
                        <th>Physician</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <?php while($patient = $patients->fetch_assoc()): 
                        $age = date_diff(date_create($patient['birthdate']), date_create('now'))->y;
                    ?>
                        <tr>
                            <td><?php echo $patient['patient_id']; ?></td>
                            <td><?php echo strtoupper($patient['patient_type']); ?></td>
                            <td><?php echo htmlspecialchars($patient['firstname'] . ' ' . $patient['lastname']); ?></td>
                            <td><?php echo $age; ?></td>
                            <td><?php echo htmlspecialchars($patient['gender']); ?></td>
                            <td><?php echo htmlspecialchars($patient['physician_name']); ?></td>
                            <td><?php echo htmlspecialchars($patient['status_label']); ?></td>
                            <td class="table-actions">
                                <a href="patient_view.php?id=<?php echo $patient['patient_id']; ?>" class="btn btn-info btn-sm">View Patient</a>
                                <form method="POST" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this patient?');">
                                    <input type="hidden" name="action" value="delete">
                                    <input type="hidden" name="patient_id" value="<?php echo $patient['patient_id']; ?>">
                                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                    <?php endwhile; ?>
                </tbody>
            </table>
        <?php else: ?>
            <p>No patients found.</p>
        <?php endif; ?>
    </div>
</div>

<script>
function togglePatientFields() {
    const type = document.getElementById('patient_type').value;
    document.getElementById('walk_in_field').style.display = type === 'walk-in' ? 'block' : 'none';
    document.getElementById('employee_field').style.display = type === 'employee' ? 'block' : 'none';
    document.getElementById('student_field').style.display = type === 'student' ? 'block' : 'none';
}

function addAsPatient(data) {
    document.getElementById('patient_type').value = data.type;
    togglePatientFields();
    
    if (data.type === 'walk-in') {
        document.getElementById('walk_in_id').value = data.id;
    } else if (data.type === 'employee') {
        document.getElementById('employee_id').value = data.id;
    } else if (data.type === 'student') {
        document.getElementById('student_id').value = data.id;
    }
    
    document.getElementById('firstname').value = data.firstname;
    document.getElementById('middlename').value = data.middlename;
    document.getElementById('lastname').value = data.lastname;
    if (data.birthdate) {
        document.getElementById('birthdate').value = data.birthdate;
    }
    if (data.gender) {
        document.getElementById('gender').value = data.gender;
    }
    
    // Scroll to form
    document.getElementById('addPatientForm').scrollIntoView({ behavior: 'smooth' });
}

// Initialize on page load
togglePatientFields();
</script>

<?php include '../includes/footer.php'; ?>
